import React, { useState, useEffect } from 'react';
import {
  TextField,
  Chip,
  MenuItem,
  Checkbox,
  ListItemText,
  InputAdornment,
  IconButton,
  Paper,
  Popper,
  Grow,
  ClickAwayListener,
  MenuList
} from '@material-ui/core';
import { Search as SearchIcon, Add as AddIcon } from '@material-ui/icons';

const MultiSelectWithSearch = ({
  options: initialOptions = [],
  selectedValues: initialSelectedValues = [],
  label = 'Select items',
  placeholder = 'Search...',
  onSelectionChange
}) => {
  const [options, setOptions] = useState(initialOptions);
  const [selectedValues, setSelectedValues] = useState(initialSelectedValues);
  const [searchText, setSearchText] = useState('');
  const [open, setOpen] = useState(false);
  const [anchorEl, setAnchorEl] = useState(null);

  useEffect(() => {
    setOptions(initialOptions);
  }, [initialOptions]);

  useEffect(() => {
    setSelectedValues(initialSelectedValues);
  }, [initialSelectedValues]);

  const handleClick = (event) => {
    setAnchorEl(event.currentTarget);
    setOpen(true);
  };

  const handleClose = () => {
    setOpen(false);
  };

  const handleSearchChange = (event) => {
    setSearchText(event.target.value);
  };

  const handleToggle = (value) => {
    const currentIndex = selectedValues.indexOf(value);
    const newSelectedValues = [...selectedValues];

    if (currentIndex === -1) {
      newSelectedValues.push(value);
    } else {
      newSelectedValues.splice(currentIndex, 1);
    }

    setSelectedValues(newSelectedValues);
    if (onSelectionChange) {
      onSelectionChange(newSelectedValues);
    }
  };

  const handleAddNewItem = () => {
    if (searchText.trim() && !options.includes(searchText)) {
      const newOptions = [...options, searchText];
      setOptions(newOptions);
      handleToggle(searchText);
      setSearchText('');
    }
  };

  const handleDeleteChip = (value) => () => {
    const newSelectedValues = selectedValues.filter(item => item !== value);
    setSelectedValues(newSelectedValues);
    if (onSelectionChange) {
      onSelectionChange(newSelectedValues);
    }
  };

  const filteredOptions = options.filter(option =>
    option.toLowerCase().includes(searchText.toLowerCase())
  );

  return (
    <div>
      <TextField
        fullWidth
        label={label}
        placeholder={placeholder}
        value={searchText}
        onClick={handleClick}
        onChange={handleSearchChange}
        InputProps={{
          startAdornment: (
            <InputAdornment position="start">
              <SearchIcon />
            </InputAdornment>
          ),
          endAdornment: (
            <InputAdornment position="end">
              <IconButton
                onClick={(e) => {
                  e.stopPropagation();
                  handleAddNewItem();
                }}
                edge="end"
                disabled={!searchText.trim()}
              >
                <AddIcon />
              </IconButton>
            </InputAdornment>
          )
        }}
      />

      <div style={{ marginTop: 8, display: 'flex', flexWrap: 'wrap', gap: 4 }}>
        {selectedValues.map((value) => (
          <Chip
            key={value}
            label={value}
            onDelete={handleDeleteChip(value)}
            style={{ margin: 2 }}
          />
        ))}
      </div>

      <Popper
        open={open}
        anchorEl={anchorEl}
        role={undefined}
        transition
        disablePortal
        style={{ zIndex: 1300, width: anchorEl?.clientWidth }}
      >
        {({ TransitionProps, placement }) => (
          <Grow
            {...TransitionProps}
            style={{
              transformOrigin: placement === 'bottom' ? 'center top' : 'center bottom',
            }}
          >
            <Paper>
              <ClickAwayListener onClickAway={handleClose}>
                <MenuList autoFocusItem={open} id="menu-list-grow">
                  {filteredOptions.length > 0 ? (
                    filteredOptions.map((option) => (
                      <MenuItem
                        key={option}
                        value={option}
                        onClick={() => handleToggle(option)}
                      >
                        <Checkbox checked={selectedValues.indexOf(option) > -1} />
                        <ListItemText primary={option} />
                      </MenuItem>
                    ))
                  ) : (
                    <MenuItem disabled>
                      No options found
                    </MenuItem>
                  )}
                </MenuList>
              </ClickAwayListener>
            </Paper>
          </Grow>
        )}
      </Popper>
    </div>
  );
};

export default MultiSelectWithSearch;
